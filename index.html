<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Deteksi Lokasi Absen - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&amp;display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Library for generation (already existing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- JSQR Library for QR scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            /* Sembunyikan overflow body agar tidak ada scrollbar saat loading overlay aktif */
            overflow: hidden; 
        }

        /* Scrollbar styling for attendance list */
        .scrollbar-thin::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: rgba(107, 114, 128, 0.5);
            border-radius: 4px;
        }

        /* IMPORTANT: Ensures display: none overrides other styles */
        .hidden {
            display: none !important;
        }

        /* Red urgent animation for "di luar lokasi" */
        @keyframes pulseRed {
            0%, 100% {
                background-color: #fee2e2;
                color: #b91c1c;
                box-shadow: 0 0 8px 2px rgba(185, 28, 28, 0.5);
            }
            50% {
                background-color: #fecaca;
                color: #991b1b;
                box-shadow: 0 0 12px 4px rgba(153, 27, 27, 0.7);
            }
        }
        .urgent-alert {
            animation: pulseRed 1.8s ease-in-out infinite;
            font-weight: 700;
            border-color: #b91c1c;
            border-width: 2px;
        }

        /* New: Styling for 'late' attendance status */
        .late-status {
            background-color: #fef3c7; /* Light yellow background */
            color: #a16207; /* Darker yellow/orange text */
            font-weight: 600;
            border-color: #d97706; /* Orange border */
            border-width: 1px;
        }

        /* Table specific styling for better appearance */
        /* Removed global table styles for attendanceList to apply them per employee table */
        #registeredEmployeesList table {
            min-width: 768px; /* Ensure table has a minimum width to enable horizontal scroll on small screens */
        }

        /* Styles for registered employees table */
        #registeredEmployeesList th,
        #registeredEmployeesList td {
            padding: 12px 16px; /* Increased padding for better spacing */
            border-bottom: 1px solid #e5e7eb; /* Subtle bottom border for rows */
        }

        #registeredEmployeesList thead th {
            background-color: #f9fafb; /* Light background for header */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.875rem; /* Smaller font for headers */
            color: #4b5563; /* Darker gray for header text */
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Last child of header row should have no bottom border to avoid double border */
        #registeredEmployeesList thead tr:last-child th {
            border-bottom: none;
        }

        /* Remove bottom border for the last row of tbody */
        #employeesTableBody tr:last-child td {
            border-bottom: none;
        }

        /* Add striped rows for better readability */
        #employeesTableBody tr:nth-child(even) {
            background-color: #f9fafb; /* Lighter background for even rows */
        }

        /* QR Scanner video/canvas styling */
        #qrVideo {
            width: 100%;
            height: auto; /* Maintain aspect ratio */
            max-height: 300px; /* Max height to prevent excessive size */
            display: block; /* Remove extra space below video */
            margin: 0 auto;
        }
        #qrCanvas {
            display: none; /* Canvas remains hidden */
        }

        /* Specific styles for individual employee attendance tables */
        .employee-attendance-card table th,
        .employee-attendance-card table td {
            padding: 12px 16px; /* Increased padding for better spacing */
            border-bottom: 1px solid #e5e7eb; /* Subtle bottom border for rows */
        }

        .employee-attendance-card table thead th {
            background-color: #f9fafb; /* Light background for header */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.875rem; /* Smaller font for headers */
            color: #4b5563; /* Darker gray for header text */
            /* New: Sticky positioning for headers in individual employee attendance tables */
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .employee-attendance-card table tbody tr:nth-child(even) {
            background-color: #f9fafb; /* Lighter background for even rows */
        }

        /* Custom Loader Styles */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a; /* Changed to dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* Ensure it's on top of everything */
            opacity: 1;
            transition: opacity 0.5s ease-out; /* Smooth transition for hiding */
            flex-direction: column; /* Stack SVG and text vertically */
            gap: 20px; /* Space between SVG and text */
        }

        .loader-overlay.fade-out {
            opacity: 0;
            pointer-events: none; /* Disable interaction during fade-out */
        }

        .loader {
            display: block;
            width: 12em;
            height: 12em;
            overflow: visible;
        }

        .loader path.fill {
            fill: rgba(125, 211, 252, 0.2); /* Lighter blue with transparency for dark mode */
            animation: fill 4s ease-in-out infinite;
        }

        .loader .dash path {
            stroke: #2AF; /* This blue is visible on dark background */
            stroke-width: 1px;
            stroke-linecap: round;
            animation: dashArray var(--sped, 2s) ease-in-out infinite,
                dashOffset var(--sped, 2s) linear infinite;
        }

        .loader .dash path.aaa {
            stroke-width: 2px;
            stroke-linecap: butt;
            clip-path: path('M 20.4603 48.5493 L 16.6461 46.9584 C 17.3209 48.3794 18.4917 49.5682 20.0447 50.2206 C 23.4007 51.6328 27.2707 50.0262 28.6694 46.6367 C 29.3464 44.9966 29.3509 43.1867 28.6806 41.5422 C 28.0103 39.8977 26.7434 38.6151 25.119 37.9315 C 23.5035 37.2544 21.7741 37.279 20.2547 37.8576 L 24.1961 39.5022 C 26.6719 40.5434 27.8427 43.4124 26.8104 45.9105 C 25.7803 48.4085 22.936 49.5905 20.4603 48.5493 Z');
        }

        .loader .dash path.big {
            stroke-width: 2px;
            filter: drop-shadow(0 0 2px #2AF);
        }

        @keyframes dashArray {
            0% {
                stroke-dasharray: 0 1 359 0;
            }
            50% {
                stroke-dasharray: 0 359 1 0;
            }
            100% {
                stroke-dasharray: 359 1 0 0;
            }
        }

        @keyframes dashOffset {
            0% {
                stroke-dashoffset: -5;
            }
            100% {
                stroke-dashoffset: -365;
            }
        }

        @keyframes fill {
            30%,
            55% {
                fill: #2AF0;
            }
        }

        /* Initially hide the main content until loading is complete */
        .content-wrapper {
            opacity: 0;
            transition: opacity 0.5s ease-in;
            pointer-events: none; /* Disable interaction until visible */
        }
        .content-wrapper.visible {
            opacity: 1;
            pointer-events: auto;
            /* Allow scrolling on the main content once visible */
            overflow: auto; 
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">

    <!-- Custom Loading Overlay -->
    <div id="customLoadingOverlay" class="loader-overlay">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" class="loader">
            <g class="dash">
                <path style="--sped: 4s;" pathLength="360" d="M 31.9463 1 C 15.6331 1 2.2692 13.6936 1 29.8237 L 17.644 36.7682 C 19.0539 35.794 20.7587 35.2264 22.5909 35.2264 C 22.7563 35.2264 22.9194 35.231 23.0803 35.2399 L 30.4828 24.412 L 30.4828 24.2601 C 30.4828 17.7446 35.7359 12.4423 42.1933 12.4423 C 48.6507 12.4423 53.9038 17.7446 53.9038 24.2601 C 53.9038 30.7756 48.6507 36.08 42.1933 36.08 C 42.104 36.08 42.0168 36.0778 41.9275 36.0755 L 31.3699 43.6747 C 31.3766 43.8155 31.3811 43.9562 31.3811 44.0947 C 31.3811 48.9881 27.4374 52.9675 22.5909 52.9675 C 18.3367 52.9675 14.7773 49.902 13.9729 45.8443 L 2.068 40.8772 C 5.7548 54.0311 17.7312 63.6748 31.9463 63.6748 C 49.0976 63.6748 63 49.6428 63 32.3374 C 63 15.0297 49.0976 1 31.9463 1 Z" class="big"></path>
                <path pathLength="360" d="M 20.4603 48.5493 L 16.6461 46.9584 C 17.3209 48.3794 18.4917 49.5682 20.0447 50.2206 C 23.4007 51.6328 27.2707 50.0262 28.6694 46.6367 C 29.3464 44.9966 29.3509 43.1867 28.6806 41.5422 C 28.0103 39.8977 26.7434 38.6151 25.119 37.9315 C 23.5035 37.2544 21.7741 37.279 20.2547 37.8576 L 24.1961 39.5022 C 26.6719 40.5434 27.8427 43.4124 26.8104 45.9105 C 25.7803 48.4085 22.936 49.5905 20.4603 48.5493 Z" class="aaa"></path>
                <path pathLength="360" d="M 49.9968 24.2603 C 49.9968 19.9188 46.4954 16.384 42.1943 16.384 C 37.8908 16.384 34.3894 19.9188 34.3894 24.2603 C 34.3894 28.6017 37.8908 32.1343 42.1943 32.1343 C 46.4954 32.1343 49.9968 28.6017 49.9968 24.2603 Z"></path>
                <path pathLength="360" d="M 36.3446 24.2469 C 36.3446 20.9802 38.97 18.3324 42.2054 18.3324 C 45.4431 18.3324 48.0685 20.9802 48.0685 24.2469 C 48.0685 27.5135 45.4431 30.1613 42.2054 30.1613 C 38.97 30.1613 36.3446 27.5135 36.3446 24.2469 Z"></path>
            </g>
            <!-- Changed fill color to light gray for better contrast on dark background -->
            <path pathLength="360" d="M 31.9463 1 C 15.6331 1 2.2692 13.6936 1 29.8237 L 17.644 36.7682 C 19.0539 35.794 20.7587 35.2264 22.5909 35.2264 C 22.7563 35.2264 22.9194 35.231 23.0803 35.2399 L 30.4828 24.412 L 30.4828 24.2601 C 30.4828 17.7446 35.7359 12.4423 42.1933 12.4423 C 48.6507 12.4423 53.9038 17.7446 53.9038 24.2601 C 53.9038 30.7756 48.6507 36.08 42.1933 36.08 C 42.104 36.08 42.0168 36.0778 41.9275 36.0755 L 31.3699 43.6747 C 31.3766 43.8155 31.3811 43.9562 31.3811 44.0947 C 31.3811 48.9881 27.4374 52.9675 22.5909 52.9675 C 18.3367 52.9675 14.7773 49.902 13.9729 45.8443 L 2.068 40.8772 C 5.7548 54.0311 17.7312 63.6748 31.9463 63.6748 C 49.0976 63.6748 63 49.6428 63 32.3374 C 63 15.0297 49.0976 1 31.9463 1 Z" fill="#e0e0e0"></path>
            <!-- The fill class path's fill color is also adjusted in CSS -->
            <path class="fill" pathLength="360" d="M 31.9463 1 C 15.6331 1 2.2692 13.6936 1 29.8237 L 17.644 36.7682 C 19.0539 35.794 20.7587 35.2264 22.5909 35.2264 C 22.7563 35.2264 22.9194 35.231 23.0803 35.2399 L 30.4828 24.412 L 30.4828 24.2601 C 30.4828 17.7446 35.7359 12.4423 42.1933 12.4423 C 48.6507 12.4423 53.9038 17.7446 53.9038 24.2601 C 53.9038 30.7756 48.6507 36.08 42.1933 36.08 C 42.104 36.08 42.0168 36.0778 41.9275 36.0755 L 31.3699 43.6747 C 31.3766 43.8155 31.3811 43.9562 31.3811 44.0947 C 31.3811 48.9881 27.4374 52.9675 22.5909 52.9675 C 18.3367 52.9675 14.7773 49.902 13.9729 45.8443 L 2.068 40.8772 C 5.7548 54.0311 17.7312 63.6748 31.9463 63.6748 C 49.0976 63.6748 63 49.6428 63 32.3374 C 63 15.0297 49.0976 1 31.9463 1 Z"></path>
        </svg>
        <p class="text-blue-200 font-semibold text-lg">Memuat Aplikasi...</p>
    </div>

    <!-- Main Content Wrapper -->
    <div id="contentWrapper" class="content-wrapper">
        <!-- Sticky Navbar -->
        <nav class="sticky top-0 bg-white shadow-sm z-20">
            <div class="max-w-5xl mx-auto flex items-center justify-between py-4 px-6">
                <div class="flex items-center space-x-2">
                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M12 8v4l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="font-extrabold text-xl tracking-tight select-none">AbsenLokasi</span>
                </div>
                <div class="space-x-4 flex items-center">
                    <a href="#fitur" class="text-gray-600 hover:text-blue-600 font-medium transition hidden md:inline-block">Fitur</a>
                    <a href="#absen" class="text-gray-600 hover:text-blue-600 font-medium transition hidden md:inline-block">Absen</a>
                    <button id="adminLoginBtn" class="text-blue-600 font-semibold hover:underline focus:outline-none" type="button">Admin Login</button>
                    <button id="adminLogoutBtn" class="text-red-600 font-semibold hover:underline focus:outline-none hidden" type="button" aria-label="Logout Admin">Logout Admin</button>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section id="heroSection" class="max-w-5xl mx-auto px-6 py-16 flex flex-col items-center text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold mb-4 tracking-tight select-none">Deteksi Lokasi Absen</h1>
            <p class="text-lg md:text-xl text-gray-600 mb-8 max-w-2xl select-none">
                Sistem absensi modern berbasis web yang memanfaatkan deteksi lokasi secara real-time. Pastikan kehadiran Anda di lokasi yang tepat, mudah dan aman!
            </p>
            <a href="#absen" class="inline-block">
                <button id="startBtn" class="px-8 py-3 bg-blue-600 text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2">
                    Mulai Absen
                </button>
            </a>
        </section>

        <!-- Fitur Section -->
        <section id="fitur" class="max-w-5xl mx-auto px-6 py-10">
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white rounded-2xl shadow p-6 flex flex-col items-center">
                    <svg class="w-10 h-10 text-blue-500 mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path d="M12 2C8 2 5 5 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-4-3-7-7-7z" />
                        <circle cx="12" cy="9" r="2.5" />
                    </svg>
                    <h3 class="font-bold text-lg mb-2 select-none">Deteksi Lokasi Akurat</h3>
                    <p class="text-gray-500 text-center select-none">Menggunakan GPS browser untuk memastikan kehadiran di lokasi yang ditentukan.</p>
                </div>
                <div class="bg-white rounded-2xl shadow p-6 flex flex-col items-center">
                    <svg class="w-10 h-10 text-blue-500 mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <rect x="3" y="7" width="18" height="13" rx="2" />
                        <path d="M16 3v4" />
                        <path d="M8 3v4" />
                    </svg>
                    <h3 class="font-bold text-lg mb-2 select-none">Mudah Digunakan</h3>
                    <p class="text-gray-500 text-center select-none">Cukup satu klik untuk absen, tanpa instalasi aplikasi tambahan.</p>
                </div>
                <div class="bg-white rounded-2xl shadow p-6 flex flex-col items-center">
                    <svg class="w-10 h-10 text-blue-500 mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path d="M5 13l4 4L19 7" />
                    </svg>
                    <h3 class="font-bold text-lg mb-2 select-none">Aman &amp; Privasi Terjaga</h3>
                    <p class="text-gray-500 text-center select-none">Data lokasi hanya digunakan untuk keperluan absensi dan tidak disimpan.</p>
                </div>
            </div>
        </section>

        <!-- Absen Section (Employee attendance) -->
        <section id="absen" class="max-w-2xl mx-auto px-6 py-12">
            <div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col items-center" id="absenSection">
                <h2 class="text-2xl font-bold mb-4 select-none">Formulir Absen Lokasi</h2>
                <p class="text-gray-500 mb-6 text-center select-none">Pilih metode absensi Anda:</p>
                <!-- Employee Identifier Input -->
                <label for="employeeName" class="self-start mb-2 font-medium text-gray-700 select-none">Nama Karyawan</label>
                <input type="text" id="employeeName" placeholder="Masukkan nama Anda" class="mb-4 w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent" autocomplete="off" />
                <button id="detectBtn" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 disabled:bg-blue-300 mb-4" disabled>
                    Deteksi Lokasi Sekarang (Dengan Nama)
                </button>
                <!-- New Scan QR Button -->
                <button id="scanQrBtn" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow hover:bg-indigo-700 transition focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2 mb-4">
                    Scan QR untuk Absen
                </button>
                <div id="locationCard" class="w-full"></div>
            </div>
        </section>

        <!-- Admin Login Section (modal style) -->
        <div id="adminLoginModal" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle" tabindex="-1" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30 transition-opacity duration-300">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-8 transform transition-transform duration-300 scale-95 opacity-0" id="loginModalContent">
                <h3 id="loginModalTitle" class="text-3xl font-extrabold text-center text-gray-800 mb-8 select-none">Admin Access</h3>
                <form id="adminLoginForm" class="flex flex-col space-y-6" autocomplete="off">
                    <div class="relative">
                        <label for="adminEmail" class="absolute -top-3 left-3 text-sm font-medium text-gray-600 bg-white px-1">Email</label>
                        <input id="adminEmail" name="adminEmail" type="email" autocomplete="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg" placeholder="Enter admin email" />
                    </div>
                    <div class="relative">
                        <label for="adminPassword" class="absolute -top-3 left-3 text-sm font-medium text-gray-600 bg-white px-1">Password</label>
                        <input id="adminPassword" name="adminPassword" type="password" autocomplete="current-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg" placeholder="Enter password" />
                    </div>
                    <button type="submit" class="mt-6 w-full py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transform hover:scale-105">
                        Login Securely
                    </button>
                    <button type="button" id="closeLoginModalBtn" class="mt-4 text-center text-gray-500 hover:text-gray-900 transition-colors duration-200 focus:outline-none">Cancel</button>
                    <p id="loginErrorMsg" class="text-red-600 text-sm mt-4 hidden select-none text-center font-medium" role="alert"></p>
                </form>
            </div>
        </div>

        <!-- Admin Dashboard Section -->
        <section id="adminDashboard" class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-6 hidden">
            <h2 class="text-3xl font-extrabold text-center mb-8 select-none">Dashboard Admin - Aktivitas & Karyawan</h2>

            <!-- Attendance Settings -->
            <div class="bg-white rounded-2xl shadow p-4 sm:p-6 mb-8">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Pengaturan Absensi</h3>
                <form id="attendanceSettingsForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="lateCutoffTime" class="block text-sm font-medium text-gray-700 mb-1">Batas Jam Kehadiran (HH:MM)</label>
                        <input type="time" id="lateCutoffTime" name="lateCutoffTime" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg" value="07:00" required>
                        <p class="text-gray-500 text-sm mt-1">Absensi setelah waktu ini akan dianggap terlambat.</p>
                    </div>
                    <div>
                        <label for="latePenaltyAmount" class="block text-sm font-medium text-gray-700 mb-1">Anggaran Denda per Menit (Rp)</label>
                        <input type="number" id="latePenaltyAmount" name="latePenaltyAmount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg" min="0" value="1000" required>
                        <p class="text-gray-500 text-sm mt-1">Denda yang dikenakan untuk setiap menit keterlambatan.</p>
                    </div>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" id="saveSettingsBtn" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow hover:bg-green-700 transition focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2">
                            Simpan Pengaturan
                        </button>
                    </div>
                    <p id="settingsSaveMsg" class="md:col-span-2 text-sm text-center font-medium mt-2 hidden"></p>
                </form>
            </div>

            <!-- Registered Employees List -->
            <div class="bg-white rounded-2xl shadow p-4 sm:p-6 mb-8">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Daftar Karyawan Terdaftar</h3>
                <div id="registeredEmployeesList" class="overflow-x-auto max-h-[300px] scrollbar-thin scrollbar-thumb-rounded scrollbar-thumb-gray-400">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b border-gray-300 text-gray-700 select-none">
                                <th class="py-3 px-4">Nama Karyawan</th>
                                <th class="py-3 px-4">ID Karyawan</th>
                                <th class="py-3 px-4">Aksi</th>
                                <th class="py-3 px-4">Kode QR</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody" class="divide-y divide-gray-200">
                            <!-- Employee rows inserted here dynamically -->
                        </tbody>
                    </table>
                    <p id="noEmployeesMsg" class="text-center text-gray-500 mt-6 select-none hidden">Belum ada karyawan terdaftar.</p>
                </div>
                <div class="flex justify-center mt-6">
                    <button id="addEmployeeBtn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2">
                        Tambah Karyawan Baru
                    </button>
                </div>
            </div>

            <!-- Employee Attendance List (Now uses individual employee tables) -->
            <div id="attendanceSection" class="bg-white rounded-2xl shadow p-4 sm:p-6">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Riwayat Absensi Karyawan</h3>
                <div id="attendanceListContainer" class="space-y-6">
                    <!-- Employee-specific attendance tables will be dynamically inserted here by JS -->
                </div>
                <p id="noAttendanceMsg" class="text-center text-gray-500 mt-6 select-none hidden">Belum ada data aktivitas karyawan.</p>
            </div>
            <div class="flex justify-center mt-6">
                <button id="resetHistoryBtn" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow hover:bg-red-700 transition focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2">
                    Reset History Absensi
                </button>
            </div>
        </section>

        <!-- Add Employee Modal -->
        <div id="addEmployeeModal" role="dialog" aria-modal="true" aria-labelledby="addEmployeeModalTitle" tabindex="-1" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30 transition-opacity duration-300">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-8 transform transition-transform duration-300 scale-95 opacity-0" id="addEmployeeModalContent">
                <h3 id="addEmployeeModalTitle" class="text-3xl font-extrabold text-center text-gray-800 mb-8 select-none">Tambah Karyawan Baru</h3>
                <form id="addEmployeeForm" class="flex flex-col space-y-6" autocomplete="off">
                    <div class="relative">
                        <label for="newEmployeeName" class="absolute -top-3 left-3 text-sm font-medium text-gray-600 bg-white px-1">Nama Karyawan</label>
                        <input id="newEmployeeName" name="newEmployeeName" type="text" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg" placeholder="Masukkan nama karyawan" />
                    </div>
                    <div class="relative">
                        <label for="newEmployeeIdDisplay" class="absolute -top-3 left-3 text-sm font-medium text-gray-600 bg-white px-1">ID Karyawan (Otomatis)</label>
                        <input id="newEmployeeIdDisplay" type="text" readonly class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-500 cursor-not-allowed text-lg font-mono" />
                    </div>
                    <p id="addEmployeeErrorMsg" class="text-red-600 text-sm mt-4 hidden select-none text-center font-medium" role="alert"></p>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancelAddEmployeeBtn" class="px-6 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition focus:outline-none focus:ring-2 focus:ring-gray-400">Batal</button>
                        <button type="submit" id="addEmployeeConfirmBtn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-400">Tambahkan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Reset Confirmation Modal -->
        <div id="resetConfirmModal" role="dialog" aria-modal="true" aria-labelledby="resetModalTitle" tabindex="-1" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center p-4 hidden z-30">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-8">
                <h3 id="resetModalTitle" class="text-2xl font-bold mb-6 text-center select-none">Konfirmasi Reset History</h3>
                <p class="text-gray-600 text-center mb-4 select-none">Masukkan PIN untuk menghapus semua data absensi karyawan:</p>
                <input type="password" id="resetPinInput" placeholder="Masukkan PIN (123)" class="mb-4 w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-transparent" autocomplete="off" />
                <p id="resetErrorMsg" class="text-red-600 text-sm mt-2 hidden text-center select-none" role="alert"></p>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelResetBtn" class="px-6 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition focus:outline-none focus:ring-2 focus:ring-gray-400">Batal</button>
                    <button type="button" id="confirmResetBtn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg shadow hover:bg-red-700 transition focus:outline-none focus:ring-2 focus:ring-red-400">Konfirmasi</button>
                </div>
            </div>
        </div>

        <!-- Employee Delete Confirmation Modal -->
        <div id="deleteEmployeeConfirmModal" role="dialog" aria-modal="true" aria-labelledby="deleteEmployeeModalTitle" tabindex="-1" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center p-4 hidden z-30">
            <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-8">
                <h3 id="deleteEmployeeModalTitle" class="text-2xl font-bold mb-6 text-center select-none">Hapus Karyawan</h3>
                <p class="text-gray-600 text-center mb-4 select-none">Anda yakin ingin menghapus karyawan <span id="employeeToDeleteName" class="font-bold"></span>?</p>
                <p class="text-red-600 text-sm mt-2 hidden text-center select-none" id="deleteEmployeeErrorMsg" role="alert"></p>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelDeleteEmployeeBtn" class="px-6 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition focus:outline-none focus:ring-2 focus:ring-gray-400">Batal</button>
                    <button type="button" id="confirmDeleteEmployeeBtn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg shadow hover:bg-red-700 transition focus:outline-none focus:ring-2 focus:ring-red-400">Hapus</button>
                </div>
            </div>
        </div>

        <!-- QR Code Display Modal (for Admin to show QR) -->
        <div id="qrCodeModal" role="dialog" aria-modal="true" aria-labelledby="qrCodeModalTitle" tabindex="-1" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30 transition-opacity duration-300">
            <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-8 transform transition-transform duration-300 scale-95 opacity-0" id="qrCodeModalContent">
                <h3 id="qrCodeModalTitle" class="text-3xl font-extrabold text-center text-gray-800 mb-8 select-none">Kode QR Karyawan</h3>
                <div id="qrcode" class="flex justify-center mb-8"></div>
                <div class="text-center text-gray-600 mb-6 select-none">
                    <p class="font-bold mb-2">ID Karyawan:</p>
                    <p id="qrEmployeeId" class="font-mono text-lg break-all"></p>
                </div>
                <button type="button" id="closeQrModalBtn" class="mt-4 w-full py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400">Tutup</button>
            </div>
        </div>

        <!-- New QR Scanner Modal (for Employee attendance) -->
        <div id="qrScannerModal" role="dialog" aria-modal="true" aria-labelledby="qrScannerModalTitle" tabindex="-1" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-40 transition-opacity duration-300">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 transform transition-transform duration-300 scale-95 opacity-0" id="qrScannerModalContent">
                <h3 id="qrScannerModalTitle" class="text-2xl font-bold text-center text-gray-800 mb-6">Scan Kode QR Karyawan</h3>
                <div class="flex flex-col items-center justify-center relative">
                    <video id="qrVideo" class="w-full rounded-lg border border-gray-300 bg-gray-100 object-cover" autoplay playsinline style="max-width: 100%; height: 240px;"></video>
                    <canvas id="qrCanvas" class="hidden"></canvas>
                    <div id="qrScanMessage" class="mt-4 text-center text-gray-700 font-medium">Arahkan kamera ke Kode QR.</div>
                    <div id="qrScanError" class="mt-2 text-center text-red-600 text-sm hidden"></div>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 mt-6 justify-center">
                    <button type="button" id="selectImageBtn" class="flex-1 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow hover:bg-green-700 transition focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2">
                        Pilih dari Galeri
                    </button>
                    <input type="file" id="qrImageInput" accept="image/*" class="hidden">
                    <button type="button" id="startCameraScanBtn" class="flex-1 px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow hover:bg-purple-700 transition focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-offset-2">
                        Gunakan Kamera
                    </button>
                </div>
                <button type="button" id="closeQrScannerModalBtn" class="mt-6 w-full py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400">Tutup Scanner</button>
            </div>
        </div>


        <!-- Footer -->
        <footer class="text-center text-gray-400 text-sm py-6 mt-auto select-none">
            &copy; 2024 AbsenLokasi. All rights reserved.
        </footer>
    </div>

<script type="module">
    // Firebase SDK Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // Added signInWithEmailAndPassword, signOut
    import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, deleteDoc, writeBatch, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global Variables
    let db;
    let auth;
    let appId;
    let isFirebaseReady = false;
    let currentAttendanceRecordsWithIds = [];
    let currentRegisteredEmployees = []; // New: To store registered employees
    let isAdminLoggedIn = false;
    let employeeIdToDelete = null; // New: To store ID of employee to be deleted

    // Variables for QR Scanner
    let videoStream = null;
    let animationFrameId = null;

    // NEW: Global variables for attendance settings, with default values
    let lateCutoffHour = 7;
    let lateCutoffMinute = 0;
    let latePenaltyPerMinute = 1000; // Rp. 1,000 per minute late

    // NEW: Variables for loading screen
    const MINIMUM_LOADING_TIME_MS = 5000; // 5 seconds
    let minimumLoadingTimeElapsed = false;
    let pageContentLoaded = false;

    // Self-executing anonymous function for app logic
    (() => {
        // Admin hardcoded credentials - REMOVED!
        // const ADMIN_USERNAME = "admin";
        // const ADMIN_PASSWORD = "password123";
        const RESET_PIN = "123"; // This PIN is for resetting history, not for admin login

        // Office coordinates (Medan, North Sumatra, Indonesia)
        const OFFICE_LAT = 3.5890625;
        const OFFICE_LON = 98.6679375;
        const ACCEPT_RADIUS_METERS = 200; // 200 meter radius

        // Elements
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const adminLoginModal = document.getElementById('adminLoginModal');
        const loginModalContent = document.getElementById('loginModalContent');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminEmailInput = document.getElementById('adminEmail'); // New: Email input
        const adminPasswordInput = document.getElementById('adminPassword'); // Renamed for clarity
        const loginErrorMsg = document.getElementById('loginErrorMsg');

        const heroSection = document.getElementById('heroSection');
        const fiturSection = document.getElementById('fitur');
        const absenSection = document.getElementById('absen');
        const adminDashboard = document.getElementById('adminDashboard');
        // Removed attendanceTableBody as it's now dynamically created per employee
        const attendanceListContainer = document.getElementById('attendanceListContainer'); // New container for employee-specific tables
        const noAttendanceMsg = document.getElementById('noAttendanceMsg');

        const employeeNameInput = document.getElementById('employeeName'); // Manual employee name input
        const detectBtn = document.getElementById('detectBtn');
        const locationCard = document.getElementById('locationCard');

        const resetHistoryBtn = document.getElementById('resetHistoryBtn');
        const resetConfirmModal = document.getElementById('resetConfirmModal');
        const resetPinInput = document.getElementById('resetPinInput');
        const resetErrorMsg = document.getElementById('resetErrorMsg');
        const confirmResetBtn = document.getElementById('confirmResetBtn');
        const cancelResetBtn = document.getElementById('cancelResetBtn');
        // Removed firebaseLoadingOverlay as it's replaced by customLoadingOverlay

        // New Employee Management Elements
        const addEmployeeBtn = document.getElementById('addEmployeeBtn');
        const addEmployeeModal = document.getElementById('addEmployeeModal');
        const addEmployeeModalContent = document.getElementById('addEmployeeModalContent');
        const addEmployeeForm = document.getElementById('addEmployeeForm');
        const newEmployeeName = document.getElementById('newEmployeeName');
        const newEmployeeIdDisplay = document.getElementById('newEmployeeIdDisplay');
        const addEmployeeErrorMsg = document.getElementById('addEmployeeErrorMsg');
        const cancelAddEmployeeBtn = document.getElementById('cancelAddEmployeeBtn');
        const addEmployeeConfirmBtn = document.getElementById('addEmployeeConfirmBtn');
        const employeesTableBody = document.getElementById('employeesTableBody');
        const noEmployeesMsg = document.getElementById('noEmployeesMsg');

        const deleteEmployeeConfirmModal = document.getElementById('deleteEmployeeConfirmModal');
        const employeeToDeleteName = document.getElementById('employeeToDeleteName');
        const deleteEmployeeErrorMsg = document.getElementById('deleteEmployeeErrorMsg');
        const cancelDeleteEmployeeBtn = document.getElementById('cancelDeleteEmployeeBtn');
        const confirmDeleteEmployeeBtn = document.getElementById('confirmDeleteEmployeeBtn');

        // QR Code Display Modal Elements (for Admin to show QR)
        const qrCodeModal = document.getElementById('qrCodeModal');
        const qrCodeModalContent = document.getElementById('qrCodeModalContent');
        const qrcodeDiv = document.getElementById('qrcode');
        const qrEmployeeIdDisplay = document.getElementById('qrEmployeeId');
        const closeQrModalBtn = document.getElementById('closeQrModalBtn');

        // New QR Scanner Modal Elements (for Employee attendance)
        const scanQrBtn = document.getElementById('scanQrBtn');
        const qrScannerModal = document.getElementById('qrScannerModal');
        const qrScannerModalContent = document.getElementById('qrScannerModalContent');
        const qrVideo = document.getElementById('qrVideo');
        const qrCanvas = document.getElementById('qrCanvas');
        const qrScanMessage = document.getElementById('qrScanMessage');
        const qrScanError = document.getElementById('qrScanError');
        const closeQrScannerModalBtn = document.getElementById('closeQrScannerModalBtn');
        const selectImageBtn = document.getElementById('selectImageBtn'); // New: Select from Gallery button
        const qrImageInput = document.getElementById('qrImageInput'); // New: Hidden file input
        const startCameraScanBtn = document.getElementById('startCameraScanBtn'); // New: Start camera scan button

        // NEW: Attendance Settings Elements
        const attendanceSettingsForm = document.getElementById('attendanceSettingsForm');
        const lateCutoffTimeInput = document.getElementById('lateCutoffTime');
        const latePenaltyAmountInput = document.getElementById('latePenaltyAmount');
        const settingsSaveMsg = document.getElementById('settingsSaveMsg');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');

        // NEW: Custom Loading Screen Elements
        const customLoadingOverlay = document.getElementById('customLoadingOverlay');
        const contentWrapper = document.getElementById('contentWrapper');

        // --- Firebase Initialization and Authentication ---
        // Removed firebaseLoadingOverlay.classList.remove('hidden'); as it's now handled by customLoadingOverlay
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDVdSSeAlhK1sgjyeSLSdNW3zesatzPKDE",
            authDomain: "data-absen-2025.firebaseapp.com",
            projectId: "data-absen-2025",
            storageBucket: "data-absen-2025.firebasestorage.app",
            messagingSenderId: "771101147789",
            appId: "1:771101147789:web:955049d4939500cfe4d8c4",
            measurementId: "G-H0S4BS3M50"
        };

        appId = firebaseConfig.projectId;

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                isFirebaseReady = true;
                // Check if the logged-in user is the admin (you'll set this up in Firebase console)
                // For now, we assume any logged-in user is admin for simplicity,
                // or you can implement custom claims later.
                // If you want to restrict admin access to a specific UID, you can do:
                // if (user.uid === 'YOUR_ADMIN_UID_HERE') { isAdminLoggedIn = true; }
                // For now, we'll rely on the manual login to set isAdminLoggedIn.
                
                await loadAttendanceSettings(); // Load settings immediately after Firebase is ready
                updateUIForAdmin(); // Update UI based on admin status
                setupFirestoreListener(); // Setup listeners for both attendance and employees
                checkAndHideLoader(); // Check if all conditions are met to hide the loader
            } else {
                try {
                    await signInAnonymously(auth);
                    // No need for a setTimeout here, as checkAndHideLoader will be called when isFirebaseReady is set to true.
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    // Even on error, attempt to hide loader so user can interact
                    checkAndHideLoader(); 
                    locationCard.innerHTML = `
                        <div class="bg-red-50 border border-red-200 text-red-600 rounded-lg p-4 mt-4 select-none">
                            Gagal terhubung ke server absensi. Mohon periksa koneksi internet Anda atau hubungi admin jika masalah berlanjut. (${error.message})
                        </div>
                    `;
                }
            }
        });

        // --- NEW: Loading Screen Logic ---
        function checkAndHideLoader() {
            if (isFirebaseReady && pageContentLoaded && minimumLoadingTimeElapsed) {
                customLoadingOverlay.classList.add('fade-out');
                // Remove the overlay from DOM after transition to avoid any clicks/interactions
                customLoadingOverlay.addEventListener('transitionend', () => {
                    customLoadingOverlay.style.display = 'none';
                    // Allow scrolling on the main content
                    document.body.style.overflow = 'auto'; 
                    contentWrapper.classList.add('visible'); // Show main content
                }, { once: true });
            }
        }

        // Mark page content loaded
        document.addEventListener('DOMContentLoaded', () => {
            pageContentLoaded = true;
            checkAndHideLoader();
        });

        // Ensure minimum loading time
        setTimeout(() => {
            minimumLoadingTimeElapsed = true;
            checkAndHideLoader();
        }, MINIMUM_LOADING_TIME_MS);

        // --- Firestore Data Management ---
        function setupFirestoreListener() {
            if (!isFirebaseReady) return;

            // Listener for Attendance Records
            const attendanceColRef = collection(db, 'artifacts', appId, 'public', 'data', 'attendanceRecords');
            onSnapshot(attendanceColRef, (snapshot) => {
                const records = [];
                snapshot.forEach(doc => {
                    records.push({ id: doc.id, ...doc.data() }); // Add Firebase document ID
                });
                records.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0)); // Sort by timestamp
                currentAttendanceRecordsWithIds = records;
                if (isAdminLoggedIn) { // Only render if admin is logged in
                    renderAttendanceTable();
                }
            }, (error) => {
                console.error("Error fetching attendance records from Firestore:", error);
                if (isAdminLoggedIn) { // Show error only if admin dashboard is active
                    noAttendanceMsg.textContent = `Gagal memuat history absensi: ${error.message}`;
                    noAttendanceMsg.classList.remove('hidden');
                }
            });

            // Listener for Registered Employees
            const employeesColRef = collection(db, 'artifacts', appId, 'public', 'data', 'registeredEmployees');
            onSnapshot(employeesColRef, (snapshot) => {
                const employees = [];
                snapshot.forEach(doc => {
                    employees.push({ id: doc.id, ...doc.data() }); // The 'id' here is the custom employee ID, not doc.id
                });
                employees.sort((a, b) => a.name.localeCompare(b.name)); // Sort by name
                currentRegisteredEmployees = employees;
                if (isAdminLoggedIn) { // Only render if admin is logged in
                    renderEmployeesTable();
                }
            }, (error) => {
                console.error("Error fetching employee records from Firestore:", error);
                if (isAdminLoggedIn) { // Show error only if admin dashboard is active
                    noEmployeesMsg.textContent = `Gagal memuat daftar karyawan: ${error.message}`;
                    noEmployeesMsg.classList.remove('hidden');
                }
            });

            // Listener for Attendance Settings
            const settingsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'attendanceSettings');
            onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    lateCutoffHour = data.lateCutoffHour !== undefined ? data.lateCutoffHour : 7;
                    lateCutoffMinute = data.lateCutoffMinute !== undefined ? data.lateCutoffMinute : 0;
                    latePenaltyPerMinute = data.latePenaltyPerMinute !== undefined ? data.latePenaltyPerMinute : 1000;
                    
                    // Update admin settings form inputs if admin is logged in
                    if (isAdminLoggedIn) {
                        lateCutoffTimeInput.value = `${String(lateCutoffHour).padStart(2, '0')}:${String(lateCutoffMinute).padStart(2, '0')}`;
                        latePenaltyAmountInput.value = latePenaltyPerMinute;
                    }
                } else {
                    // If settings document doesn't exist, create it with default values
                    // This will be handled by the saveSettings function if user explicitly saves.
                    // For now, ensure global variables hold default values.
                    lateCutoffHour = 7;
                    lateCutoffMinute = 0;
                    latePenaltyPerMinute = 1000;
                    if (isAdminLoggedIn) {
                        lateCutoffTimeInput.value = '07:00';
                        latePenaltyAmountInput.value = 1000;
                    }
                }
            }, (error) => {
                console.error("Error fetching attendance settings from Firestore:", error);
                if (isAdminLoggedIn) {
                    settingsSaveMsg.textContent = `Gagal memuat pengaturan: ${error.message}`;
                    settingsSaveMsg.classList.add('text-red-600');
                    settingsSaveMsg.classList.remove('hidden');
                }
            });
        }

        async function loadAttendanceSettings() {
            if (!isFirebaseReady) return;
            const settingsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'attendanceSettings');
            try {
                const docSnap = await getDoc(settingsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    lateCutoffHour = data.lateCutoffHour !== undefined ? data.lateCutoffHour : 7;
                    lateCutoffMinute = data.lateCutoffMinute !== undefined ? data.lateCutoffMinute : 0;
                    latePenaltyPerMinute = data.latePenaltyPerMinute !== undefined ? data.latePenaltyPerMinute : 1000;
                } else {
                    // If no settings exist, initialize with defaults
                    await saveAttendanceSettings(7, 0, 1000);
                }
            } catch (e) {
                console.error("Error loading attendance settings:", e);
                // Fallback to default values if loading fails
                lateCutoffHour = 7;
                lateCutoffMinute = 0;
                latePenaltyPerMinute = 1000;
            }
        }

        async function saveAttendanceSettings(hour, minute, penalty) {
            if (!isFirebaseReady) {
                settingsSaveMsg.textContent = 'Server tidak siap. Coba lagi.';
                settingsSaveMsg.classList.add('text-red-600');
                settingsSaveMsg.classList.remove('hidden');
                return false;
            }
            const settingsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'attendanceSettings');
            try {
                await setDoc(settingsDocRef, {
                    lateCutoffHour: hour,
                    lateCutoffMinute: minute,
                    latePenaltyPerMinute: penalty
                });
                console.log("Attendance settings saved successfully!");
                settingsSaveMsg.textContent = 'Pengaturan berhasil disimpan!';
                settingsSaveMsg.classList.remove('text-red-600', 'hidden');
                settingsSaveMsg.classList.add('text-green-600');
                setTimeout(() => settingsSaveMsg.classList.add('hidden'), 3000);
                return true;
            } catch (e) {
                console.error("Error saving attendance settings: ", e);
                settingsSaveMsg.textContent = `Gagal menyimpan pengaturan: ${e.message}`;
                settingsSaveMsg.classList.remove('hidden', 'text-green-600');
                settingsSaveMsg.classList.add('text-red-600');
                return false;
            }
        }

        async function saveAttendanceRecord(record) {
            if (!isFirebaseReady) {
                locationCard.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 rounded-lg p-4 mt-4 select-none">
                        Aplikasi belum siap untuk menyimpan data. Silakan coba lagi.
                    </div>
                `;
                return;
            }
            try {
                const attendanceColRef = collection(db, 'artifacts', appId, 'public', 'data', 'attendanceRecords');
                await addDoc(attendanceColRef, {
                    ...record,
                    timestamp: Date.now()
                });
            } catch (e) {
                console.error("Error adding document to Firestore: ", e);
                locationCard.innerHTML = `
                    <div class="bg-red-50 border border-red-200 text-red-600 rounded-lg p-4 mt-4 select-none">
                        Gagal menyimpan absensi ke server: ${e.message}
                    </div>
                `;
            }
        }

        async function addEmployeeToFirestore(name, id) {
            if (!isFirebaseReady) {
                addEmployeeErrorMsg.textContent = 'Server tidak siap. Coba lagi.';
                addEmployeeErrorMsg.classList.remove('hidden');
                return false;
            }
            try {
                // Use custom employee ID as document ID for easy lookup
                const employeeDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'registeredEmployees', id);
                await setDoc(employeeDocRef, { name: name, id: id });
                return true;
            } catch (e) {
                console.error("Error adding employee to Firestore: ", e);
                addEmployeeErrorMsg.textContent = `Gagal menambahkan karyawan: ${e.message}`;
                addEmployeeErrorMsg.classList.remove('hidden');
                return false;
            }
        }

        async function deleteEmployeeFromFirestore(employeeId) {
            if (!isFirebaseReady) {
                deleteEmployeeErrorMsg.textContent = 'Server tidak siap. Coba lagi.';
                deleteEmployeeErrorMsg.classList.remove('hidden');
                return false;
            }
            try {
                const employeeDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'registeredEmployees', employeeId);
                await deleteDoc(employeeDocRef);
                return true;
            } catch (e) {
                console.error("Error deleting employee from Firestore: ", e);
                deleteEmployeeErrorMsg.textContent = `Gagal menghapus karyawan: ${e.message}`;
                deleteEmployeeErrorMsg.classList.remove('hidden');
                return false;
            }
        }

        // This function is now responsible for rendering individual employee attendance tables
        function renderAttendanceTable() {
            // Get the container where individual employee attendance blocks will be added
            const attendanceListContainer = document.getElementById('attendanceListContainer');
            attendanceListContainer.innerHTML = ''; // Clear existing content before re-rendering

            // Check if there are any attendance records at all
            if (currentAttendanceRecordsWithIds.length === 0) {
                noAttendanceMsg.classList.remove('hidden'); // Show the "no data" message
                return; // Exit if no records
            } else {
                noAttendanceMsg.classList.add('hidden'); // Hide the "no data" message
            }

            // Group attendance records by employee ID
            // The `record.id` in `currentAttendanceRecordsWithIds` array refers to the `employeeId`
            const groupedAttendance = new Map(); // Map: employeeId -> Array of attendance records
            for (const record of currentAttendanceRecordsWithIds) {
                if (!groupedAttendance.has(record.id)) {
                    groupedAttendance.set(record.id, []);
                }
                groupedAttendance.get(record.id).push(record);
            }

            // Iterate through each grouped employee's records and create a separate table/card
            for (const [employeeId, records] of groupedAttendance.entries()) {
                // Find the employee's current registered name; fallback to name in record if not found
                const employee = currentRegisteredEmployees.find(emp => emp.id === employeeId);
                const employeeName = employee ? employee.name : (records[0] ? records[0].name : 'Karyawan Tidak Dikenal');
                const attendanceCount = records.length;

                const employeeCardDiv = document.createElement('div');
                // Apply styling for each employee's attendance box (card-like appearance)
                employeeCardDiv.classList.add('employee-attendance-card', 'bg-gray-50', 'rounded-xl', 'shadow-md', 'p-4', 'sm:p-6', 'border', 'border-gray-200');

                employeeCardDiv.innerHTML = `
                    <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                        <span>${escapeHtml(employeeName)}</span>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-semibold rounded-full">${attendanceCount} Kehadiran</span>
                    </h4>
                    <div class="overflow-x-auto max-h-[300px] scrollbar-thin scrollbar-thumb-rounded scrollbar-thumb-gray-400">
                        <table class="w-full text-left border-collapse min-w-[700px]"> <!-- Increased min-width for new columns -->
                            <thead>
                                <tr class="border-b border-gray-300 text-gray-700 select-none bg-gray-100">
                                    <th class="py-3 px-4">Tanggal &amp; Waktu</th>
                                    <th class="py-3 px-4">Latitude</th>
                                    <th class="py-3 px-4">Longitude</th>
                                    <th class="py-3 px-4">Alamat</th>
                                    <th class="py-3 px-4">Keterangan</th>
                                    <th class="py-3 px-4">Status Waktu</th>
                                    <th class="py-3 px-4">Keterangan Denda</th> <!-- New column -->
                                    <th class="py-3 px-4">Jumlah Denda</th> <!-- New column -->
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200" id="attendanceTableBody-${escapeHtml(employeeId)}">
                                <!-- Attendance rows for this employee will be appended here -->
                            </tbody>
                        </table>
                    </div>
                    ${attendanceCount === 0 ? `<p class="text-center text-gray-500 mt-4">Belum ada absensi untuk karyawan ini.</p>` : ''}
                `;
                attendanceListContainer.appendChild(employeeCardDiv);

                // Get the tbody for the current employee's table
                const currentEmployeeTableBody = document.getElementById(`attendanceTableBody-${escapeHtml(employeeId)}`);

                // Sort records for the current employee by timestamp in descending order (newest first)
                records.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                // Populate the table body with attendance records for this employee
                for (const r of records) {
                    // Determine status text and class
                    let statusText = r.keterangan;
                    let statusClass = r.keterangan === 'Di luar lokasi' ? 'text-red-700 urgent-alert' : 'text-green-700';

                    // Handle late status for UI
                    let lateStatusText = r.isLate ? `Telat ${r.lateMinutes} menit` : 'Tepat Waktu';
                    let lateStatusClass = r.isLate ? 'text-red-600 font-semibold' : 'text-green-600';
                    let lateIconSvg = r.isLate ? `<svg class="inline-block w-4 h-4 mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>` : '';

                    // Penalty related display
                    let penaltyKeterangan = r.isLate ? `Terlambat ${r.lateMinutes} menit` : '-';
                    let penaltyAmount = r.isLate && r.penaltyAmount ? `Rp. ${r.penaltyAmount.toLocaleString('id-ID')}` : '-';
                    let penaltyClass = r.isLate ? 'text-red-600 font-bold' : 'text-gray-500';

                    const tr = document.createElement('tr');
                    tr.classList.add('hover:bg-gray-50', 'transition');
                    tr.innerHTML = `
                        <td class="py-3 px-4 text-sm">${escapeHtml(r.datetime)}</td>
                        <td class="py-3 px-4 text-sm font-mono">${escapeHtml(r.latitude)}</td>
                        <td class="py-3 px-4 text-sm font-mono">${escapeHtml(r.longitude)}</td>
                        <td class="py-3 px-4 text-sm">${escapeHtml(r.address)}</td>
                        <td class="py-3 px-4 text-sm font-semibold ${statusClass} select-none">
                            ${escapeHtml(statusText)}
                        </td>
                        <td class="py-3 px-4 text-sm ${lateStatusClass} select-none">
                            ${lateIconSvg} ${escapeHtml(lateStatusText)}
                        </td>
                        <td class="py-3 px-4 text-sm ${penaltyClass} select-none">
                            ${escapeHtml(penaltyKeterangan)}
                        </td>
                        <td class="py-3 px-4 text-sm ${penaltyClass} select-none">
                            ${escapeHtml(penaltyAmount)}
                        </td>
                    `;
                    currentEmployeeTableBody.appendChild(tr);
                }
            }
        }


        function renderEmployeesTable() {
            employeesTableBody.innerHTML = '';
            if (currentRegisteredEmployees.length === 0) {
                noEmployeesMsg.classList.remove('hidden');
            } else {
                noEmployeesMsg.classList.add('hidden');
                for (const emp of currentRegisteredEmployees) {
                    const tr = document.createElement('tr');
                    tr.classList.add('hover:bg-gray-50', 'transition');
                    tr.innerHTML = `
                        <td class="py-3 px-4 font-medium">${escapeHtml(emp.name)}</td>
                        <td class="py-3 px-4 font-mono text-xs break-all">${escapeHtml(emp.id)}</td>
                        <td class="py-3 px-4">
                            <button data-employee-id="${escapeHtml(emp.id)}" data-employee-name="${escapeHtml(emp.name)}" class="delete-employee-btn px-3 py-1 bg-red-500 text-white text-sm font-semibold rounded-md hover:bg-red-600 transition">
                                Hapus
                            </button>
                        </td>
                        <td class="py-3 px-4"> <!-- New column for QR Code button -->
                            <button data-employee-id="${escapeHtml(emp.id)}" class="generate-qr-btn px-3 py-1 bg-blue-600 text-white text-sm font-semibold rounded-md hover:bg-blue-700 transition">
                                QR
                            </button>
                        </td>
                    `;
                    employeesTableBody.appendChild(tr);
                }

                // Add event listeners to newly created delete buttons
                document.querySelectorAll('.delete-employee-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        employeeIdToDelete = e.target.dataset.employeeId;
                        const nameToDelete = e.target.dataset.employeeName;
                        employeeToDeleteName.textContent = nameToDelete;
                        deleteEmployeeErrorMsg.classList.add('hidden');
                        deleteEmployeeConfirmModal.classList.remove('hidden');
                    });
                });

                // Add event listeners to newly created QR buttons
                document.querySelectorAll('.generate-qr-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const employeeId = e.target.dataset.employeeId;
                        displayQrCode(employeeId);
                    });
                });
            }
        }

        // Function to display QR code in a modal
        function displayQrCode(employeeId) {
            qrcodeDiv.innerHTML = ''; // Clear previous QR code
            qrEmployeeIdDisplay.textContent = employeeId;

            new QRCode(qrcodeDiv, {
                text: employeeId,
                width: 180,
                height: 180,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            qrCodeModal.classList.remove('hidden'); // Show modal backdrop
            // Apply animation classes
            qrCodeModalContent.classList.remove('opacity-0', 'scale-95');
            qrCodeModalContent.classList.add('opacity-100', 'scale-100');
            qrCodeModal.focus(); // Focus the modal for accessibility
        }


        // Escape HTML for security (prevent XSS)
        function escapeHtml(text) {
            return text.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }

        // Helper function to check if two dates are the same day
        function isSameDay(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() &&
                    d1.getMonth() === d2.getMonth() &&
                    d1.getDate() === d2.getDate();
        }

        // Helper function to format date
        function formatDate(date) {
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            return new Intl.DateTimeFormat('id-ID', options).format(date);
        }

        // Helper function to format time (e.g., 07:45)
        function formatTime(date) {
            const options = { hour: '2-digit', minute: '2-digit' };
            return new Intl.DateTimeFormat('id-ID', options).format(date);
        }

        // Helper function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        }

        function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radius of the earth in meters
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Distance in meters
            return d;
        }
        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // --- Core Attendance Recording Logic ---
        async function recordAttendance(employeeName, employeeId) {
            locationCard.innerHTML = `
                <div class="flex items-center justify-center space-x-2 mt-2">
                    <svg class="w-5 h-5 animate-spin text-blue-600" fill="none" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                    </svg>
                    <span class="text-blue-600 font-medium">Mendeteksi lokasi...</span>
                </div>
            `;

            // Check for duplicate attendance for the current employee on the current day
            const today = new Date();
            const existingAttendanceToday = currentAttendanceRecordsWithIds.find(record =>
                record.id === employeeId && // Crucially check by employee ID
                record.timestamp && // Ensure timestamp exists
                isSameDay(new Date(record.timestamp), today)
            );

            if (existingAttendanceToday) {
                const recordedTime = formatTime(new Date(existingAttendanceToday.timestamp));
                locationCard.innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 text-blue-700 rounded-lg p-4 mt-4 select-none">
                        Anda sudah absen hari ini pada pukul ${recordedTime}.
                    </div>
                `;
                // Clear manual input only if it was used for this attempt
                employeeNameInput.value = '';
                detectBtn.disabled = true;
                return;
            }

            if (!navigator.geolocation) {
                locationCard.innerHTML = `
                    <div class="bg-red-50 border border-red-200 text-red-600 rounded-lg p-4 mt-4 select-none">
                        Browser Anda tidak mendukung deteksi lokasi.
                    </div>
                `;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const { latitude, longitude } = position.coords;
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`);
                        const data = await response.json();
                        const address = data.display_name || "Alamat tidak ditemukan";
                        const now = new Date();

                        const distance = getDistanceFromLatLonInMeters(latitude, longitude, OFFICE_LAT, OFFICE_LON);
                        const inLocation = distance <= ACCEPT_RADIUS_METERS;

                        const keterangan = inLocation ? 'Di lokasi' : 'Di luar lokasi';

                        // Lateness calculation using global settings
                        let isLate = false;
                        let lateMinutes = 0; // In minutes
                        let penaltyAmount = 0; // In Rupiah

                        // Create a cutoff date for today at LATE_CUTOFF_HOUR:LATE_CUTOFF_MINUTE
                        const cutoffDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), lateCutoffHour, lateCutoffMinute, 0, 0);

                        if (now.getTime() > cutoffDate.getTime()) {
                            isLate = true;
                            const diffMs = now.getTime() - cutoffDate.getTime();
                            lateMinutes = Math.ceil(diffMs / (1000 * 60)); // Round up to nearest minute
                            penaltyAmount = lateMinutes * latePenaltyPerMinute;
                        }

                        let locationCardContent = '';
                        let statusBadgeClass = '';
                        let statusTextClass = '';
                        let statusIcon = '';

                        if (inLocation) {
                            statusBadgeClass = 'bg-green-50 border-green-200';
                            statusTextClass = 'text-green-700';
                            statusIcon = `
                                <svg class="w-8 h-8 text-green-500 mb-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                    <path d="M5 13l4 4L19 7" />
                                </svg>
                            `;
                        } else {
                            statusBadgeClass = 'urgent-alert'; // Uses animation
                            statusTextClass = 'text-red-700';
                            statusIcon = `
                                <svg class="w-10 h-10 mb-3" fill="none" stroke="#b91c1c" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                    <path d="M12 9v2m0 4h.01M10.29 6.16a8 8 0 1113.42 10.69m-5.67-10.57L3 21" />
                                </svg>
                            `;
                        }

                        let lateBadge = '';
                        let penaltyInfo = '';

                        if (isLate) {
                            lateBadge = `
                                <div class="mt-3 text-red-600 font-bold flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                    TERLAMBAT: ${lateMinutes} menit
                                </div>
                            `;
                            penaltyInfo = `
                                <div class="text-red-700 font-bold mt-2">
                                    Denda Keterlambatan: ${formatCurrency(penaltyAmount)}
                                </div>
                            `;
                        }


                        locationCardContent = `
                                <div class="${statusBadgeClass} border rounded-xl p-5 mt-4 flex flex-col items-center select-text">
                                    ${statusIcon}
                                    <div class="${statusTextClass} font-semibold mb-1">${inLocation ? 'Absensi berhasil dicatat!' : 'PERINGATAN DARURAT: Karyawan tidak di lokasi kantor!'}</div>
                                    <div class="text-gray-700 text-sm">Nama: <span class="font-semibold">${escapeHtml(employeeName)}</span></div>
                                    <div class="text-gray-700 text-sm">Waktu: <span class="font-mono">${formatDate(now)}</span></div>
                                    <div class="text-gray-700 text-sm">Latitude: <span class="font-mono">${latitude.toFixed(6)}</span></div>
                                    <div class="text-gray-700 text-sm">Longitude: <span class="font-mono">${longitude.toFixed(6)}</span></div>
                                    <div class="text-gray-700 text-sm mt-2">Alamat: <span class="font-mono">${escapeHtml(address)}</span></div>
                                    <div class="${statusTextClass} font-bold mt-3 select-none">${keterangan}</div>
                                    ${lateBadge} <!-- Add late badge if applicable -->
                                    ${penaltyInfo} <!-- Add penalty info if applicable -->
                                </div>
                            `;
                        locationCard.innerHTML = locationCardContent;

                        const record = {
                            name: employeeName,
                            id: employeeId, // Include employee ID in attendance record
                            datetime: formatDate(now),
                            latitude: latitude.toFixed(6),
                            longitude: longitude.toFixed(6),
                            address: address,
                            keterangan: keterangan,
                            isLate: isLate, // Add isLate status
                            lateMinutes: lateMinutes, // Add minutes late
                            penaltyAmount: penaltyAmount // Add penalty amount
                        };
                        saveAttendanceRecord(record);

                        // Clear manual input only if it was used
                        employeeNameInput.value = '';
                        detectBtn.disabled = true;

                    } catch (error) {
                        console.error("Error fetching address or processing location:", error);
                        locationCard.innerHTML = `
                            <div class="bg-red-50 border border-red-200 text-red-600 rounded-lg p-4 mt-4 select-none">
                                Gagal mendapatkan alamat atau mencatat absensi: ${error.message}
                            </div>
                        `;
                    }
                },
                function(error) {
                    let message = "Gagal mendeteksi lokasi.";
                    if (error.code === 1) message = "Izin lokasi ditolak. Silakan izinkan akses lokasi pada browser Anda.";
                    else if (error.code === 2) message = "Lokasi tidak tersedia.";
                    else if (error.code === 3) message = "Permintaan lokasi melebihi waktu tunggu.";
                    locationCard.innerHTML = `
                        <div class="bg-red-50 border border-red-200 text-red-600 rounded-lg p-4 mt-4 select-none">
                            ${message}
                        </div>
                    `;
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        // --- UI Logic and Event Listeners ---

        // Employee Name Input for Absen section
        employeeNameInput.addEventListener('input', () => {
            detectBtn.disabled = employeeNameInput.value.trim().length === 0;
        });

        // Admin Login/Logout workflow
        adminLoginBtn.addEventListener('click', () => {
            loginErrorMsg.classList.add('hidden');
            adminLoginForm.reset();
            adminLoginModal.classList.remove('hidden'); // Show modal backdrop
            // Apply animation classes
            loginModalContent.classList.remove('opacity-0', 'scale-95');
            loginModalContent.classList.add('opacity-100', 'scale-100');
            adminEmailInput.focus(); // Focus on email input
        });

        document.getElementById('closeLoginModalBtn').addEventListener('click', () => {
            // Hide modal content with animation first
            loginModalContent.classList.remove('opacity-100', 'scale-100');
            loginModalContent.classList.add('opacity-0', 'scale-95');
            // Hide modal backdrop after animation
            loginModalContent.addEventListener('transitionend', function handler() {
                adminLoginModal.classList.add('hidden');
                loginModalContent.removeEventListener('transitionend', handler);
            }, {once: true});
        });
        window.addEventListener('keydown', e => {
            if (e.key === 'Escape' && !adminLoginModal.classList.contains('hidden')) {
                document.getElementById('closeLoginModalBtn').click(); // Simulate click on close button
            }
        });

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = adminEmailInput.value.trim();
            const password = adminPasswordInput.value;

            loginErrorMsg.classList.add('hidden'); // Hide previous errors
            
            try {
                // Sign in with email and password using Firebase Auth
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("Admin berhasil login:", user.email);
                isAdminLoggedIn = true; // Set admin status to true

                // Sembunyikan modal dengan animasi
                loginModalContent.classList.remove('opacity-100', 'scale-100');
                loginModalContent.classList.add('opacity-0', 'scale-95');

                // Setelah animasi selesai, sembunyikan backdrop dan update UI
                loginModalContent.addEventListener('transitionend', function handler() {
                    adminLoginModal.classList.add('hidden');
                    loginModalContent.removeEventListener('transitionend', handler);
                    updateUIForAdmin();
                }, {once: true});

            } catch (error) {
                console.error("Login admin gagal:", error.code, error.message);
                let errorMessage = 'Login gagal. Periksa email dan password Anda.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'Email atau password salah.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Format email tidak valid.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Terlalu banyak percobaan login. Coba lagi nanti.';
                }
                loginErrorMsg.textContent = errorMessage;
                loginErrorMsg.classList.remove('hidden');
            }
        });

        adminLogoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth); // Sign out from Firebase
                isAdminLoggedIn = false;
                updateUIForAdmin();
            } catch (error) {
                console.error("Error logging out:", error);
                // Optionally display an error message if logout fails
            }
        });

        function updateUIForAdmin() {
            if (isAdminLoggedIn) {
                // Populate settings inputs
                lateCutoffTimeInput.value = `${String(lateCutoffHour).padStart(2, '0')}:${String(lateCutoffMinute).padStart(2, '0')}`;
                latePenaltyAmountInput.value = latePenaltyPerMinute;
                settingsSaveMsg.classList.add('hidden'); // Hide any previous save message

                // Hide regular user sections
                heroSection.classList.add('hidden');
                fiturSection.classList.add('hidden');
                absenSection.classList.add('hidden');
                adminLoginBtn.classList.add('hidden');

                // Show admin dashboard and logout button
                adminDashboard.classList.remove('hidden');
                adminLogoutBtn.classList.remove('hidden');

                // Clear user section inputs/messages
                locationCard.innerHTML = '';
                employeeNameInput.value = '';
                detectBtn.disabled = true;

                renderAttendanceTable(); // Re-render table with Firestore data
                renderEmployeesTable(); // Re-render employees table
            } else {
                // Hide admin dashboard and logout button
                adminDashboard.classList.add('hidden');
                adminLogoutBtn.classList.add('hidden');

                // Show regular user sections
                heroSection.classList.remove('hidden');
                fiturSection.classList.remove('hidden');
                absenSection.classList.remove('hidden');
                adminLoginBtn.classList.remove('hidden');

                // Clear admin section inputs/messages
                locationCard.innerHTML = ''; // This is used by user section too, but cleared here to ensure consistency.
            }
        }

        document.getElementById('startBtn').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('absen').scrollIntoView({ behavior: 'smooth' });
        });

        // Employee Attendance (Detect Location) Logic for manual name input
        detectBtn.addEventListener('click', () => {
            const employeeName = employeeNameInput.value.trim();
            if (employeeName.length === 0) {
                locationCard.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 rounded-lg p-4 mt-4 select-none">
                        Silakan masukkan nama karyawan terlebih dahulu.
                    </div>
                `;
                return;
            }
            // Find employee ID by name
            const registeredEmployee = currentRegisteredEmployees.find(emp => emp.name.toLowerCase() === employeeName.toLowerCase());
            if (!registeredEmployee) {
                locationCard.innerHTML = `
                        <div class="bg-red-50 border border-red-200 text-red-600 rounded-lg p-4 mt-4 select-none">
                            Nama karyawan "${escapeHtml(employeeName)}" tidak terdaftar. Harap hubungi admin.
                        </div>
                    `;
                employeeNameInput.value = '';
                detectBtn.disabled = true;
                return;
            }
            recordAttendance(registeredEmployee.name, registeredEmployee.id);
        });

        // Reset History functionality
        resetHistoryBtn.addEventListener('click', () => {
            resetPinInput.value = '';
            resetErrorMsg.classList.add('hidden');
            resetConfirmModal.classList.remove('hidden');
            resetPinInput.focus();
        });

        cancelResetBtn.addEventListener('click', () => {
            resetConfirmModal.classList.add('hidden');
        });

        confirmResetBtn.addEventListener('click', async () => {
            const enteredPin = resetPinInput.value;
            if (enteredPin === RESET_PIN) {
                if (!isFirebaseReady) {
                    resetErrorMsg.textContent = 'Server tidak siap. Coba lagi.';
                    resetErrorMsg.classList.remove('hidden');
                    return;
                }
                try {
                    const attendanceColRef = collection(db, 'artifacts', appId, 'public', 'data', 'attendanceRecords');
                    const q = query(attendanceColRef);
                    const querySnapshot = await getDocs(q);

                    const batch = writeBatch(db);
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    console.log("All records deleted from Firestore!");
                    resetConfirmModal.classList.add('hidden');
                    locationCard.innerHTML = `
                        <div class="bg-green-50 border border-green-200 text-green-700 rounded-lg p-4 mt-4 select-none">
                            History absensi berhasil dihapus!
                        </div>
                    `;
                    setTimeout(() => locationCard.innerHTML = '', 3000);
                } catch (e) {
                    console.error("Error deleting documents: ", e);
                    resetErrorMsg.textContent = `Gagal menghapus history: ${e.message}`;
                    resetErrorMsg.classList.remove('hidden');
                }
            } else {
                resetErrorMsg.textContent = 'PIN salah. Silakan coba lagi.';
                resetErrorMsg.classList.remove('hidden');
            }
        });

        // New: Add Employee Functionality
        addEmployeeBtn.addEventListener('click', () => {
            newEmployeeName.value = '';
            newEmployeeIdDisplay.value = crypto.randomUUID(); // Generate random ID
            addEmployeeErrorMsg.classList.add('hidden');
            addEmployeeModal.classList.remove('hidden');
            addEmployeeModalContent.classList.remove('opacity-0', 'scale-95');
            addEmployeeModalContent.classList.add('opacity-100', 'scale-100');
            newEmployeeName.focus();
        });

        cancelAddEmployeeBtn.addEventListener('click', () => {
            addEmployeeModalContent.classList.remove('opacity-100', 'scale-100');
            addEmployeeModalContent.classList.add('opacity-0', 'scale-95');
            addEmployeeModalContent.addEventListener('transitionend', function handler() {
                addEmployeeModal.classList.add('hidden');
                addEmployeeModalContent.removeEventListener('transitionend', handler);
            }, {once: true});
        });

        addEmployeeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = newEmployeeName.value.trim();
            const id = newEmployeeIdDisplay.value;

            if (name.length === 0) {
                addEmployeeErrorMsg.textContent = 'Nama karyawan tidak boleh kosong.';
                addEmployeeErrorMsg.classList.remove('hidden');
                return;
            }

            // Check if employee name already exists (case-insensitive)
            const nameExists = currentRegisteredEmployees.some(emp => emp.name.toLowerCase() === name.toLowerCase());
            if (nameExists) {
                addEmployeeErrorMsg.textContent = 'Nama karyawan ini sudah terdaftar.';
                addEmployeeErrorMsg.classList.remove('hidden');
                return;
            }

            addEmployeeConfirmBtn.disabled = true; // Disable button during submission
            addEmployeeErrorMsg.classList.add('hidden');

            const success = await addEmployeeToFirestore(name, id);
            if (success) {
                addEmployeeModalContent.classList.remove('opacity-100', 'scale-100');
                addEmployeeModalContent.classList.add('opacity-0', 'scale-95');
                addEmployeeModalContent.addEventListener('transitionend', function handler() {
                    addEmployeeModal.classList.add('hidden');
                    addEmployeeModalContent.removeEventListener('transitionend', handler);
                    // Optionally show a temporary success message in the main dashboard
                    locationCard.innerHTML = `
                        <div class="bg-green-50 border border-green-200 text-green-700 rounded-lg p-4 mt-4 select-none">
                            Karyawan "${escapeHtml(name)}" berhasil ditambahkan!
                        </div>
                    `;
                    setTimeout(() => locationCard.innerHTML = '', 3000); // Clear message after 3 seconds
                }, {once: true});
            }
            addEmployeeConfirmBtn.disabled = false; // Re-enable button
        });

        // New: Delete Employee Functionality
        cancelDeleteEmployeeBtn.addEventListener('click', () => {
            deleteEmployeeConfirmModal.classList.add('hidden');
            employeeIdToDelete = null;
        });

        confirmDeleteEmployeeBtn.addEventListener('click', async () => {
            if (!employeeIdToDelete) return;

            confirmDeleteEmployeeBtn.disabled = true; // Disable button during deletion
            deleteEmployeeErrorMsg.classList.add('hidden');

            const success = await deleteEmployeeFromFirestore(employeeIdToDelete);
            if (success) {
                deleteEmployeeConfirmModal.classList.add('hidden');
                // Optionally show success message
                locationCard.innerHTML = `
                    <div class="bg-green-50 border border-green-200 text-green-700 rounded-lg p-4 mt-4 select-none">
                        Karyawan berhasil dihapus!
                    </div>
                `;
                setTimeout(() => locationCard.innerHTML = '', 3000);
            }
            confirmDeleteEmployeeBtn.disabled = false;
            employeeIdToDelete = null; // Clear the stored ID
        });

        // Close QR modal (for admin to display QR)
        closeQrModalBtn.addEventListener('click', () => {
            qrCodeModalContent.classList.remove('opacity-100', 'scale-100');
            qrCodeModalContent.classList.add('opacity-0', 'scale-95');
            qrCodeModalContent.addEventListener('transitionend', function handler() {
                qrCodeModal.classList.add('hidden');
                qrCodeModalContent.removeEventListener('transitionend', handler);
            }, {once: true});
        });

        // --- QR Scanner Functionality for Attendance ---

        // Event listener for the "Scan QR" button on the front page
        scanQrBtn.addEventListener('click', () => {
            qrScanMessage.textContent = 'Pilih metode pemindaian QR Code.';
            qrScanError.classList.add('hidden');
            qrVideo.classList.add('hidden'); // Hide video initially
            qrScannerModal.classList.remove('hidden'); // Show modal backdrop
            // Apply animation classes
            qrScannerModalContent.classList.remove('opacity-0', 'scale-95');
            qrScannerModalContent.classList.add('opacity-100', 'scale-100');
            qrScannerModal.focus(); // Focus the modal for accessibility
        });

        // Event listener for "Pilih dari Galeri" button
        selectImageBtn.addEventListener('click', () => {
            qrImageInput.click(); // Trigger the hidden file input
        });

        // Event listener for when an image is selected from the gallery
        qrImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                stopQrScanner(); // Stop camera if it's running
                qrVideo.classList.add('hidden'); // Ensure video is hidden
                qrScanMessage.textContent = 'Memindai gambar...';
                qrScanError.classList.add('hidden');

                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const ctx = qrCanvas.getContext('2d');
                        // Set canvas dimensions to fit the image while maintaining aspect ratio
                        const aspectRatio = img.width / img.height;
                        const maxWidth = 300; // Max width for canvas rendering
                        const maxHeight = 300; // Max height for canvas rendering

                        let drawWidth = img.width;
                        let drawHeight = img.height;

                        if (drawWidth > maxWidth) {
                            drawWidth = maxWidth;
                            drawHeight = drawWidth / aspectRatio;
                        }
                        if (drawHeight > maxHeight) {
                            drawHeight = maxHeight;
                            drawWidth = drawHeight * aspectRatio;
                        }

                        qrCanvas.width = drawWidth;
                        qrCanvas.height = drawHeight;

                        ctx.drawImage(img, 0, 0, drawWidth, drawHeight);
                        const imageData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);

                        if (code) {
                            processScannedQr(code.data);
                        } else {
                            qrScanError.textContent = 'Tidak dapat menemukan QR Code pada gambar yang dipilih.';
                            qrScanError.classList.remove('hidden');
                            qrScanMessage.textContent = 'Pilih gambar lain atau gunakan kamera.';
                        }
                    };
                    img.onerror = () => {
                        qrScanError.textContent = 'Gagal memuat gambar.';
                        qrScanError.classList.remove('hidden');
                        qrScanMessage.textContent = 'Pilih gambar lain atau gunakan kamera.';
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
            qrImageInput.value = ''; // Clear the file input
        });

        // Event listener for "Gunakan Kamera" button
        startCameraScanBtn.addEventListener('click', () => {
            startCameraScanner();
        });


        // Event listener for closing the QR scanner modal
        closeQrScannerModalBtn.addEventListener('click', () => {
            stopQrScanner(); // Stop the camera stream
            qrScannerModalContent.classList.remove('opacity-100', 'scale-100');
            qrScannerModalContent.classList.add('opacity-0', 'scale-95');
            qrScannerModalContent.addEventListener('transitionend', function handler() {
                qrScannerModal.classList.add('hidden');
                qrScannerModalContent.removeEventListener('transitionend', handler);
                qrVideo.classList.remove('hidden'); // Ensure video is visible if we start camera again later
            }, {once: true});
        });

        // Function to start the QR scanner from camera
        async function startCameraScanner() {
            if (videoStream) stopQrScanner(); // Ensure any previous stream is stopped

            try {
                qrScanMessage.textContent = 'Memulai kamera...';
                qrScanError.classList.add('hidden');
                qrVideo.classList.remove('hidden'); // Show video element

                // Request camera access, preferring the environment-facing camera
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                qrVideo.srcObject = stream;
                videoStream = stream; // Store stream to stop it later

                // Once video metadata is loaded, play the video and start scanning
                qrVideo.onloadedmetadata = () => {
                    qrVideo.play();
                    // Set canvas dimensions to match video stream
                    qrCanvas.width = qrVideo.videoWidth;
                    qrCanvas.height = qrVideo.videoHeight;
                    scanQrCode(); // Start the scanning loop
                    qrScanMessage.textContent = 'Arahkan kamera ke Kode QR.'; // Reset message
                };
            } catch (err) {
                console.error("Error accessing camera: ", err);
                let msg = 'Gagal mengakses kamera.';
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    msg = 'Izin kamera ditolak. Harap izinkan akses kamera di pengaturan browser Anda.';
                } else if (err.name === 'NotFoundError') {
                    msg = 'Tidak ada kamera yang ditemukan.';
                } else if (err.name === 'NotReadableError') {
                    msg = 'Kamera sedang digunakan oleh aplikasi lain.';
                }
                qrScanError.textContent = msg;
                qrScanError.classList.remove('hidden');
                qrScanMessage.textContent = ''; // Clear scanning message
                qrVideo.classList.add('hidden'); // Hide video if camera access fails
            }
        }

        // Function to continuously scan for QR codes (from camera)
        function scanQrCode() {
            if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
                const ctx = qrCanvas.getContext('2d', { willReadFrequently: true });
                // Set canvas dimensions to match video stream if not already set (for mobile rotation etc.)
                if (qrCanvas.width !== qrVideo.videoWidth || qrCanvas.height !== qrVideo.videoHeight) {
                    qrCanvas.width = qrVideo.videoWidth;
                    qrCanvas.height = qrVideo.videoHeight;
                }

                // Draw the video frame onto the canvas
                ctx.drawImage(qrVideo, 0, 0, qrCanvas.width, qrCanvas.height);
                // Get image data from the canvas
                const imageData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                // Use jsQR to find QR codes
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert", // Optimize for various QR codes
                });

                if (code) {
                    // QR code found! Stop the scanner and process the data
                    stopQrScanner();
                    processScannedQr(code.data);
                    return; // Exit the function to prevent further scanning in this loop
                }
            }
            // Continue scanning in the next animation frame
            animationFrameId = requestAnimationFrame(scanQrCode);
        }

        // Function to stop the QR scanner camera stream and animation loop
        function stopQrScanner() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            if (videoStream) {
                // Stop all tracks (video, audio) in the stream
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                qrVideo.srcObject = null; // Disconnect the stream from the video element
            }
        }

        // Function to process the scanned QR code data
        function processScannedQr(scannedId) {
            // Find the employee in the registered employees list using the scanned ID
            const registeredEmployee = currentRegisteredEmployees.find(emp => emp.id === scannedId);

            if (registeredEmployee) {
                // Valid employee found! Record attendance
                recordAttendance(registeredEmployee.name, registeredEmployee.id);
                closeQrScannerModalBtn.click(); // Close the scanner modal after successful scan
            } else {
                // Scanned ID does not match any registered employee
                qrScanError.textContent = `Kode QR tidak valid atau karyawan tidak terdaftar: ${escapeHtml(scannedId)}`;
                qrScanError.classList.remove('hidden');
                qrScanMessage.textContent = 'Pilih gambar lain atau gunakan kamera.'; // Update message for next attempt
                // Re-enable camera or prompt for gallery if it was a camera scan
                if (videoStream) { // If it was a live camera scan
                    startCameraScanner(); // Restart camera to allow rescanning
                }
            }
        }

        // NEW: Event listener for saving attendance settings
        attendanceSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const timeValue = lateCutoffTimeInput.value; // e.g., "07:30"
            const [hour, minute] = timeValue.split(':').map(Number);
            const penalty = parseInt(latePenaltyAmountInput.value, 10);

            if (isNaN(hour) || isNaN(minute) || hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                settingsSaveMsg.textContent = 'Format waktu tidak valid. Gunakan HH:MM.';
                settingsSaveMsg.classList.remove('hidden', 'text-green-600');
                settingsSaveMsg.classList.add('text-red-600');
                return;
            }
            if (isNaN(penalty) || penalty < 0) {
                settingsSaveMsg.textContent = 'Jumlah denda tidak valid. Masukkan angka positif.';
                settingsSaveMsg.classList.remove('hidden', 'text-green-600');
                settingsSaveMsg.classList.add('text-red-600');
                return;
            }

            saveSettingsBtn.disabled = true;
            settingsSaveMsg.textContent = 'Menyimpan pengaturan...';
            settingsSaveMsg.classList.remove('hidden', 'text-red-600', 'text-green-600');
            
            const success = await saveAttendanceSettings(hour, minute, penalty);
            if (success) {
                lateCutoffHour = hour;
                lateCutoffMinute = minute;
                latePenaltyPerMinute = penalty;
            }
            saveSettingsBtn.disabled = false;
        });


        window.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                if (!adminLoginModal.classList.contains('hidden')) {
                    document.getElementById('closeLoginModalBtn').click();
                } else if (!resetConfirmModal.classList.contains('hidden')) {
                    cancelResetBtn.click();
                } else if (!addEmployeeModal.classList.contains('hidden')) {
                    cancelAddEmployeeBtn.click();
                } else if (!deleteEmployeeConfirmModal.classList.contains('hidden')) {
                    cancelDeleteEmployeeBtn.click();
                } else if (!qrCodeModal.classList.contains('hidden')) {
                    closeQrModalBtn.click();
                } else if (!qrScannerModal.classList.contains('hidden')) { // Handle QR scanner modal
                    closeQrScannerModalBtn.click();
                }
            }
        });

        // Initial UI update will happen after Firebase authentication
        updateUIForAdmin();

    })();
</script>
</body>
</html>
